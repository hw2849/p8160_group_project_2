---
title: "logistics"
author: "Xinran Sun"
date: "3/17/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(caret)
library(ggcorrplot)
library(MASS)

```

## data import and data clean
```{r}
#load the data
breast_dat = read.csv("breast-cancer.csv") %>% 
  janitor::clean_names() %>% 
  dplyr::select(-1, -33) %>% #drop NA column
  mutate(diagnosis = recode(diagnosis, "M" = 1, "B" = 0)) 

head(breast_dat, 5)

r = dim(breast_dat)[1] #row number
c = dim(breast_dat)[2] #column number

var_names = names(breast_dat)[-c(1,2)] #variable names
  
standardize = function(col) {
  mean = mean(col)
  sd = sd(col)
  return((col - mean)/sd)
}

stand_df = breast_dat %>% 
  dplyr::select(radius_mean:fractal_dimension_worst) %>% 
  map_df(.x = ., standardize) #standardize

X = stand_df #predictors
y = as.vector(ifelse(breast_dat[,2] == "M", 1, 0))#response
```

## check collinearity

```{r}
corr = stand_df %>% 
  cor()

ggcorrplot(corr, type = "upper")

#X = stand_df %>% 
  #select(radius_mean, texture_mean, smoothness_mean, compactness_mean,
         #symmetry_mean, fractal_dimension_mean, radius_se, texture_se,
         #smoothness_se, concavity_se, symmetry_se)

#corr_new = X %>% cor()
#corr_new

#ggcorrplot(corr_new, type = "upper", lab = TRUE)
```

```{r}
logdata = cbind.data.frame(y, X)
log_model = glm(y ~ ., family = binomial(link = "logit"),data = logdata)
summary(log_model)
```


## Newton-Raphson algorithm

```{r haotian lin}
## logistic stuff 

logisticstuff = function(dat, betavec){
  
  x = dat[, -1] %>% as.matrix()
  x = cbind(rep(1, nrow(x)), scale(x))
  y = as.matrix(dat[, 1])

  theta = x %*% betavec
  p = exp(theta) / (1 + exp(theta))
  
  loglik = sum(y * theta - log(1 + exp(theta)))

  grad = t(x) %*% (y - p) # gradient
  
 # w = p * (1 - p)
 # w = diag(as.vector(w), nrow = nrow(w))
 # print(w)
  hess = -(t(x) %*% diag(c(p*(1-p))) %*% x) # hessian matrix
  
  return(list(loglik = loglik, grad = grad, hess = hess))

}

beta = rep(1, 31) 
test = logisticstuff(breast_dat, betavec = beta)
test$loglik
```


```{r haotian lin}

newtonraphson = function(dat, func, start, tol = 1e-8, maxiter = 100){
  i = 0
  curbeta = start
  stuff = func(dat, curbeta)
  res = c(0, stuff$loglik, curbeta)
  prevloglik = -Inf
   
  while (i < maxiter && abs(stuff$loglik - prevloglik) > tol) {
    i = i + 1
    prevloglik = stuff$loglik
    prev = curbeta
    curbeta = prev - solve(stuff$hess) %*% stuff$grad
    stuff = func(dat, curbeta)

    #redirection
    j = 1
    while (stuff$loglik < prevloglik) {
      
      if (!all(eigen(stuff$hess)$values) < 0) {
      #gamma = max(eigen(stuff$hess)$values)
      new_hess = stuff$hess - diag(31)
      curbeta = prev - solve(new_hess) %*% stuff$grad
      }
      else {
      j = j/2
      curbeta = prev - j * solve(stuff$hess) %*% stuff$grad
      }
    }
    
    stuff = func(dat, curbeta)
    res = rbind(res, c(i, stuff$loglik, curbeta))
  }
  return(res)
}

res = newtonraphson(breast_dat, logisticstuff, beta)
```
